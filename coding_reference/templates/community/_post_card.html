<div class="card mb-3" id="post-{{ post.id }}">
    <div class="card-body">
        <div class="d-flex align-items-start">
            <div class="flex-shrink-0">
                {% if post.is_anonymous %}
                    <img src="{{ url_for('static', filename='profile_pics/default_anonymous.png') }}" class="rounded-circle" width="40" height="40" alt="匿名ユーザー">
                {% else %}
                    <a href="{{ url_for('profile.user_profile', username=post.author.username) }}">
                        <img src="{{ url_for('static', filename='profile_pics/' + post.author.profile.image_file) }}" class="rounded-circle" width="40" height="40" alt="{{ post.author.username }}">
                    </a>
                {% endif %}
            </div>

            <div class="ms-3 w-100">
                <div class="d-flex justify-content-between">
                    <div>
                        {% if post.is_anonymous %}
                            <span class="fw-bold text-dark">匿名さん</span>
                        {% else %}
                            <a href="{{ url_for('profile.user_profile', username=post.author.username) }}" class="fw-bold text-dark text-decoration-none">{{ post.author.username }}</a>
                        {% endif %}
                        <small class="text-muted ms-2">{{ (post.created_at | jst).strftime('%Y/%m/%d %H:%M') }}</small>
                        
                        {% if post.edit_history %}
                        <small class="text-muted ms-1"
                               style="cursor: pointer;"
                               data-bs-toggle="modal"
                               data-bs-target="#mainModal"
                               data-url="{{ url_for('community.post_history', post_id=post.id) }}"
                               data-title="編集履歴"
                               title="編集履歴を見る">(編集済み)</small>
                        {% endif %}
                        {% if post.is_pinned and request.endpoint == 'profile.user_profile' %}
                            <span class="ms-2 text-muted" title="ピン留めされた投稿"><i class="bi bi-pin-angle-fill"></i></span>
                        {% endif %}
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light py-0 px-1" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <button type="button" class="dropdown-item"
                                        data-bs-toggle="modal"
                                        data-bs-target="#mainModal"
                                        data-url="{{ url_for('community.post_history', post_id=post.id) }}"
                                        data-title="編集履歴">
                                    <i class="fas fa-history me-2"></i>編集履歴
                                </button>
                            </li>

                            {% if current_user.is_authenticated and not post.is_anonymous and (post.author == current_user or current_user.is_admin) %}
                                <li><hr class="dropdown-divider"></li>
                                {% if post.is_pinned %}
                                    <li><a class="dropdown-item" href="{{ url_for('profile.unpin_post', post_id=post.id) }}"><i class="bi bi-pin-angle me-2"></i>ピン留めを解除</a></li>
                                {% else %}
                                    <li><a class="dropdown-item" href="{{ url_for('profile.pin_post', post_id=post.id) }}"><i class="bi bi-pin-angle-fill me-2"></i>ピン留めする</a></li>
                                {% endif %}

                                <li>
                                    <button type="button" class="dropdown-item"
                                            data-bs-toggle="modal"
                                            data-bs-target="#mainModal"
                                            data-url="{{ url_for('community.edit_post', post_id=post.id) }}"
                                            data-title="投稿の編集">
                                        <i class="bi bi-pencil-square me-2"></i>編集
                                    </button>
                                </li>
                                <li>
                                    <form action="{{ url_for('community.delete_post', post_id=post.id) }}" method="POST" onsubmit="return confirm('本当にこの投稿を削除しますか？\n関連するコメントもすべて削除されます。');" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="dropdown-item text-danger"><i class="bi bi-trash-fill me-2"></i>削除</button>
                                    </form>
                                </li>
                            {% endif %}

                            {% if current_user.is_authenticated and (post.is_anonymous or post.author != current_user) %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" data-bs-toggle="collapse" href="#reportPostForm-{{ post.id }}"><i class="bi bi-flag-fill me-2"></i>この投稿を報告する</a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                
                <div class="my-1">
                    {% if post.visibility == 'private' %}<span class="badge rounded-pill text-bg-secondary"><i class="bi bi-lock-fill me-1"></i>限定公開</span>{% endif %}
                    {% if post.is_adult %}<span class="badge rounded-pill text-bg-danger">成人向け</span>{% endif %}
                    {% for category in post.categories %}<a href="{{ url_for('community.board_index', category=category.id) }}" class="badge rounded-pill text-bg-light text-decoration-none fw-normal">{{ category.name }}</a>{% endfor %}
                    {% for tag in post.tags %}<a href="{{ url_for('community.board_index', q='#' ~ tag.name) }}" class="badge rounded-pill text-bg-primary text-decoration-none fw-normal">#{{ tag.name }}</a>{% endfor %}
                </div>

                <a href="{{ url_for('community.post_detail', post_id=post.id) }}" class="text-dark text-decoration-none">
                    <div class="post-content mb-1">{{ post.content | format_content | bleach | safe }}</div>
                </a>

                {% if post.media_filename %}
                <div class="mt-2">
                    {% if post.media_type == 'image' %}
                        <img src="{{ url_for('static', filename='community_uploads/' + post.media_filename) }}" class="img-fluid rounded border protected-media" alt="投稿画像">
                    {% elif post.media_type == 'video' %}
                        <video src="{{ url_for('static', filename='community_uploads/' + post.media_filename) }}" class="img-fluid rounded border protected-media" controls controlsList="nodownload"></video>
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="mt-1 d-flex align-items-center">
                    {% if current_user.is_authenticated and post.author == current_user %}
                        <a href="#" class="text-muted text-decoration-none me-3" data-bs-toggle="modal" data-bs-target="#likersModal" data-post-id="{{ post.id }}">
                           <i class="bi bi-heart-fill text-danger"></i>
                           <span class="ms-1 like-count" id="like-count-{{ post.id }}">{{ like_count if like_count is defined else post.liked_by.count() }}</span>
                        </a>
                    {% else %}
                        <div
                            id="like-btn-{{ post.id }}"
                            class="me-3 like-button-vue"
                            data-post-id="{{ post.id }}"
                            data-liked="{% if current_user.is_authenticated and post.is_liked_by(current_user) %}true{% else %}false{% endif %}"
                            data-likes-count="{{ like_count if like_count is defined else post.liked_by.count() }}">
                        </div>
                    {% endif %}

                    <a href="{{ url_for('community.post_detail', post_id=post.id) }}" class="text-muted text-decoration-none ms-3">
                        <i class="bi bi-chat-dots me-1"></i>
                        <span>{{ comment_count if comment_count is defined else post.comments|length }}</span>
                    </a>

                    {% if current_user.is_authenticated %}
                    <div
                        class="ms-3 bookmark-button-vue"
                        data-post-id="{{ post.id }}"
                        data-bookmarked="{{ 'true' if post.is_bookmarked_by(current_user) else 'false' }}">
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="collapse" id="reportPostForm-{{ post.id }}">
    <div class="card card-body mt-2 bg-light border-danger">
        <form action="{{ url_for('community.report') }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="post_id" value="{{ post.id }}">
            <h6 class="card-title">この投稿を通報する</h6>
            <div class="mb-2">
                <select name="reason" class="form-select form-select-sm" required>
                    <option value="">理由を選択してください</option>
                    <option value="inappropriate_content">不適切なコンテンツ</option>
                    <option value="harassment">誹謗中傷・ハラスメント</option>
                    <option value="spam">スパム・宣伝行為</option>
                    <option value="copyright_infringement">著作権侵害</option>
                    <option value="other">その他</option>
                </select>
            </div>
            <div class="mb-2">
                <textarea name="details" class="form-control form-control-sm" rows="2" placeholder="詳細（任意）"></textarea>
            </div>
            <div class="text-end">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="collapse" data-bs-target="#reportPostForm-{{ post.id }}">キャンセル</button>
                <button type="submit" class="btn btn-sm btn-danger">送信</button>
            </div>
        </form>
    </div>
</div>