{% extends "base.html" %}

{% block title %}{{ title }} - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-2">
        <div class="position-sticky" style="top: 5rem;">
            <nav class="nav flex-column nav-pills left-sidebar-nav">
                <a class="nav-link {% if request.endpoint == 'community.board_index' %}active{% endif %}" href="{{ url_for('community.board_index') }}">
                    <i class="bi bi-house-door-fill me-2"></i> ホーム
                </a>
                <a class="nav-link {% if request.endpoint == 'auth.mypage' %}active{% endif %}" href="{{ url_for('auth.mypage') }}">
                    <i class="bi bi-person-fill me-2"></i> マイページ
                </a>
                <a class="nav-link" href="#" id="notification-nav-link" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-bell-fill me-2"></i> 通知
                </a>
                <a class="nav-link {% if request.blueprint == 'dm' %}active{% endif %}" href="{{ url_for('dm.inbox') }}">
                    <i class="bi bi-envelope-fill me-2"></i> DM
                </a>
                <a class="nav-link {% if request.endpoint == 'community.bookmarks' %}active{% endif %}" href="{{ url_for('community.bookmarks') }}">
                    <i class="bi bi-bookmark-fill me-2"></i> ブックマーク
                </a>

                {% if current_mode == 'anonymous' %}
                    <a class="nav-link" href="{{ url_for('community.board_index', mode='normal', feed=current_feed, category=selected_category, q=search_query) }}">
                        <i class="bi bi-person-check-fill me-2"></i> 通常モードへ
                    </a>
                {% else %}
                    <a class="nav-link" href="{{ url_for('community.board_index', mode='anonymous', feed=current_feed, category=selected_category, q=search_query) }}">
                        <i class="bi bi-person-fill-slash me-2"></i> 匿名モードへ
                    </a>
                {% endif %}

                {% if current_user.is_authenticated %}
                    <a class="nav-link {% if request.endpoint == 'community.drafts' %}active{% endif %}" href="{{ url_for('community.drafts') }}">
                        <i class="bi bi-archive-fill me-2"></i> 下書き一覧
                    </a>
                {% endif %}

                <a class="nav-link {% if request.endpoint == 'community.community_settings' %}active{% endif %}" href="{{ url_for('community.community_settings') }}">
                    <i class="bi bi-gear-fill me-2"></i> 設定
                </a>
                <div class="mt-3 d-grid">
                     <button type="button" class="btn btn-primary modal-trigger-btn"
                        data-bs-toggle="modal" data-bs-target="#mainModal"
                        data-url="{{ url_for('community.new_post') }}"
                        data-title="新しい投稿">
                        投稿する
                    </button>
                </div>
            </nav>
        </div>
    </div>

    <div class="col-md-7 mt-4">
        {% set url_args = {
            'q': search_query or none,
            'category': selected_category or none,
            'mode': current_mode or none
        } %}

        <ul class="nav nav-tabs nav-justified mb-3 feed-nav">
            <li class="nav-item">
                <a class="nav-link {% if current_feed == 'all' %}active{% endif %}" href="{{ url_for('community.board_index', feed='all', **url_args) }}"><i class="bi bi-globe-asia-australia"></i><span class="feed-text">すべて</span></a>
            </li>
            {% if current_user.is_authenticated %}
            <li class="nav-item">
                <a class="nav-link {% if current_feed == 'following' %}active{% endif %}" href="{{ url_for('community.board_index', feed='following', **url_args) }}"><i class="bi bi-people"></i><span class="feed-text">フォロー中</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if current_feed == 'my_posts' %}active{% endif %}" href="{{ url_for('community.board_index', feed='my_posts', **url_args) }}"><i class="bi bi-person-square"></i><span class="feed-text">自分の投稿</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if current_feed == 'vtuber' %}active{% endif %}" href="{{ url_for('community.board_index', feed='vtuber', **url_args) }}"><i class="bi bi-star"></i><span class="feed-text">推され人</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if current_feed == 'fan' %}active{% endif %}" href="{{ url_for('community.board_index', feed='fan', **url_args) }}"><i class="bi bi-heart"></i><span class="feed-text">推す人</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link {% if current_feed == 'creator' %}active{% endif %}" href="{{ url_for('community.board_index', feed='creator', **url_args) }}"><i class="bi bi-briefcase"></i><span class="feed-text">お仕事人</span></a>
            </li>
            {% endif %}
        </ul>


        <div id="posts-list">
            {% if posts.items %}
                {% for post in posts.items %}
                    <div id="post-{{ post.id }}">
                        {% include 'community/_post_card.html' %}
                    </div>
                {% endfor %}
            {% else %}
                <div id="no-posts-message" class="card"><div class="card-body text-center text-muted"><p class="my-3">この条件に一致する投稿はありません。</p></div></div>
            {% endif %}
        </div>

        <div id="board-vue-app" class="mt-3"></div>

        {% set page_url_args = {'q': search_query or none, 'category': selected_category or none, 'feed': current_feed or 'all', 'mode': current_mode or 'normal'} %}
        <div id="loading-trigger" data-next-url="{% if posts.has_next %}{{ url_for('community.board_index', page=posts.next_num, **page_url_args) }}{% endif %}">
            <div class="d-flex justify-content-center my-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

    </div>

    <div class="col-md-3">
        <div class="position-sticky" style="top: 5rem;">

            <div class="card widget-card mb-4">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('community.board_index') }}">
                        <input type="hidden" name="feed" value="{{ current_feed or 'all' }}">
                        {% if selected_category %}<input type="hidden" name="category" value="{{ selected_category }}">{% endif %}
                        <input type="hidden" name="mode" value="{{ current_mode or 'normal' }}">

                        <div class="input-group mb-3">
                            <input type="text" class="form-control" placeholder="#タグ or キーワードで検索..." name="q" value="{{ search_query or '' }}">
                            <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                        </div>
                    </form>
                    <div class="row row-cols-3 g-2 category-grid">
                        <div class="col">
                            <a href="{{ url_for('community.board_index', q=search_query or none, feed=current_feed or 'all', mode=current_mode or 'normal') }}" class="btn btn-sm {% if not selected_category %}btn-dark{% else %}btn-outline-dark{% endif %} w-100">すべて</a>
                        </div>
                        {% for category in categories %}
                        <div class="col">
                            <a href="{{ url_for('community.board_index', category=category.id, q=search_query or none, feed=current_feed or 'all', mode=current_mode or 'normal') }}" class="btn btn-sm {% if selected_category == category.id %}btn-dark{% else %}btn-outline-dark{% endif %} w-100">
                                {{ category.name }}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="card widget-card mb-4">
                <div class="card-header widget-card-header fw-bold d-flex justify-content-between align-items-center">
                    おすすめユーザー
                </div>
                <ul class="list-group list-group-flush user-list">
                    <li class="list-group-item user-list-item">
                        <img src="https://i.pravatar.cc/40?u=user1" alt="avatar" class="rounded-circle me-2">
                        <div class="user-info flex-grow-1">
                            <strong>Creative-Artist</strong>
                        </div>
                        <button class="btn btn-outline-primary btn-sm">フォロー</button>
                    </li>
                    <li class="list-group-item user-list-item">
                        <img src="https://i.pravatar.cc/40?u=user2" alt="avatar" class="rounded-circle me-2">
                        <div class="user-info flex-grow-1">
                            <strong>Music-Maker</strong>
                        </div>
                        <button class="btn btn-outline-primary btn-sm">フォロー</button>
                    </li>
                    <li class="list-group-item user-list-item">
                        <img src="https://i.pravatar.cc/40?u=user3" alt="avatar" class="rounded-circle me-2">
                        <div class="user-info flex-grow-1">
                            <strong>Game-Dev-Guru</strong>
                        </div>
                        <button class="btn btn-outline-primary btn-sm">フォロー</button>
                    </li>
                </ul>
            </div>

            <div class="card widget-card">
                <div class="card-header widget-card-header fw-bold">
                    お気に入りタグ
                </div>
                <div class="card-body tag-list">
                    {% if current_user.is_authenticated and favorited_tags %}
                        {% for tag in favorited_tags %}
                            <a href="{{ url_for('community.board_index', q='#' ~ tag.name) }}" class="badge rounded-pill text-bg-primary text-decoration-none fw-normal">#{{ tag.name }}</a>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted small mb-0">お気に入りタグはまだありません。設定ページから登録できます。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<button type="button" class="fab modal-trigger-btn"
        data-bs-toggle="modal" data-bs-target="#mainModal"
        data-url="{{ url_for('community.new_post') }}"
        data-title="新しい投稿"
        aria-label="新しい投稿を作成">
    <i class="fas fa-pencil-alt"></i>
</button>
{% endblock %}

{% block scripts %}
    <script type="module" src="{{ url_for('static', filename='js/community_board_vue.js') }}"></script>
    <script src="{{ url_for('static', filename='js/infinite_scroll_vue.js') }}"></script>
{% endblock %}